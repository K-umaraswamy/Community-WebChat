var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _react=require("react");var _useFuegoContext2=_interopRequireDefault(require("../useFuegoContext"));var _useAppState=_interopRequireDefault(require("../useAppState"));var _default=function _default(){var _useFuegoContext=(0,_useFuegoContext2.default)(),auth=_useFuegoContext.auth,firebase=_useFuegoContext.firebase;var uid='';var lastSentStatus=(0,_react.useRef)();var ready=(0,_react.useRef)(false);var databaseRef=(0,_react.useMemo)(function(){return firebase.database().ref("/status/"+uid);},[uid]);var status=(0,_react.useCallback)(function(state){return{state:state,lastChanged:firebase.database.ServerValue.TIMESTAMP};},[]);var onAppStateChange=(0,_react.useCallback)(function(state){if(ready.current&&state!==lastSentStatus.current){databaseRef.set(status(state));}},[]);(0,_useAppState.default)(onAppStateChange);try{;var _ref=auth().currentUser;uid=_ref.uid;}catch(e){console.error('oh shoot, invalid auth in useOnlineStatus hook',e);}(0,_react.useEffect)(function(){var infoRef=firebase.database().ref('.info/connected');infoRef.on('value',function _callee(snapshot){return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(snapshot.val()){_context.next=2;break;}return _context.abrupt("return");case 2:_context.prev=2;_context.next=5;return _regenerator.default.awrap(databaseRef.onDisconnect().set(status('inactive')));case 5:ready.current=true;lastSentStatus.current='active';databaseRef.set(status(lastSentStatus.current));_context.next=13;break;case 10:_context.prev=10;_context.t0=_context["catch"](2);console.error("useOnlineStatus error within snapshot listener "+_context.t0);case 13:case"end":return _context.stop();}}},null,null,[[2,10]]);});return function(){try{lastSentStatus.current='inactive';databaseRef.set(status(lastSentStatus.current));infoRef.off('value');}catch(e){console.error('useOnlineStatus cleanup effect error',e);}};},[uid]);};exports.default=_default;
//# sourceMappingURL=index.js.map