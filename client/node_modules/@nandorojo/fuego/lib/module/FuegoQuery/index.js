import _regeneratorRuntime from"@babel/runtime/regenerator";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function multipleConditions(w){return!!w&&Array.isArray(w[0]);}function multipleOrderBy(o){return Array.isArray(o[0]);}var _default=function(){function _default(config){_classCallCheck(this,_default);this.config=config;}_createClass(_default,[{key:"getRef",value:function getRef(db){var ref=null;var _this$config=this.config,path=_this$config.path,where=_this$config.where,orderBy=_this$config.orderBy,limit=_this$config.limit,startAt=_this$config.startAt,endAt=_this$config.endAt,startAfter=_this$config.startAfter,endBefore=_this$config.endBefore;var isDocument=false;try{if(!path)throw new Error('Empty path supplied to getRef in FuegoQuery class');isDocument=path.split('/').filter(Boolean).length%2===0;if(isDocument){ref=db.doc(path);}else{ref=db.collection(path);if(where){if(multipleConditions(where)){;where.forEach(function(w){ref=ref.where(w[0],w[1],w[2]);});}else if(typeof where[0]==='string'&&typeof where[1]==='string'){ref=ref.where(where[0],where[1],where[2]);}}if(orderBy){if(typeof orderBy==='string'){ref=ref.orderBy(orderBy);}else if(Array.isArray(orderBy)){if(multipleOrderBy(orderBy)){;orderBy.forEach(function(order){var _ref;ref=(_ref=ref).orderBy.apply(_ref,_toConsumableArray(order));});}else{var _ref2=orderBy,_ref3=_slicedToArray(_ref2,2),order=_ref3[0],direction=_ref3[1];ref=ref.orderBy(order,direction);}}}if(startAt){ref=ref.startAt(startAt);}if(endAt){ref=ref.endAt(endAt);}if(startAfter){ref=ref.startAfter(startAfter);}if(endBefore){ref=ref.endBefore(endBefore);}if(limit){ref=ref.limit(limit);}}}catch(e){console.error(e);}return{ref:ref,isDocument:isDocument};}},{key:"getQueryStringId",value:function getQueryStringId(){var _this=this;return JSON.stringify(Object.keys(this.config).sort().map(function(configType){return _defineProperty({},configType,_this.config[configType]);}));}},{key:"handle",value:function handle(_ref5){var listenerNameRef,context,dbRef,_ref5$listen,listen,_ref5$notifyOnNetwork,notifyOnNetworkStatusChange,setData,setLoading,setError,setExists,path,db,addListener,doesListenerExist,getListener,_this$getRef,isDocument,ref,doc,response,r,listenerExists;return _regeneratorRuntime.async(function handle$(_context){while(1){switch(_context.prev=_context.next){case 0:listenerNameRef=_ref5.listenerNameRef,context=_ref5.context,dbRef=_ref5.dbRef,_ref5$listen=_ref5.listen,listen=_ref5$listen===void 0?false:_ref5$listen,_ref5$notifyOnNetwork=_ref5.notifyOnNetworkStatusChange,notifyOnNetworkStatusChange=_ref5$notifyOnNetwork===void 0?true:_ref5$notifyOnNetwork,setData=_ref5.setData,setLoading=_ref5.setLoading,setError=_ref5.setError,setExists=_ref5.setExists;path=this.config.path;_context.prev=2;if(path){_context.next=5;break;}return _context.abrupt("return",console.warn('You called the useFuego hook without providing a path. \nIf you want access to the firestore db object, try using useFuegoContext() instead.'));case 5:if(context){_context.next=7;break;}throw new Error('missing context from firestore query handler. check useFuego');case 7:db=context.db,addListener=context.addListener,doesListenerExist=context.doesListenerExist,getListener=context.getListener;listenerNameRef.current=this.getQueryStringId();_this$getRef=this.getRef(db),isDocument=_this$getRef.isDocument,ref=_this$getRef.ref;dbRef.current=ref;if(listen){_context.next=30;break;}if(!isDocument){_context.next=20;break;}_context.next=15;return _regeneratorRuntime.awrap(dbRef.current.get());case 15:doc=_context.sent;setExists(doc.exists);if(doc.exists){setData(_objectSpread({},doc.data({serverTimestamps:'estimate'}),{id:doc.id}));}_context.next=27;break;case 20:_context.next=22;return _regeneratorRuntime.awrap(dbRef.current.get());case 22:response=_context.sent;r=[];response.forEach(function(doc){return r.push(_objectSpread({},doc.data({serverTimestamps:'estimate'}),{id:doc.id}));});setExists(!response.empty);if(!response.empty){setData(r);}case 27:if(notifyOnNetworkStatusChange)setLoading(false);_context.next=32;break;case 30:listenerExists=doesListenerExist(listenerNameRef.current);if(listenerExists){console.warn("Warning, you're trying to initialize the same listener twice. This applies to the firestore query: ",this.config.path);getListener(listenerNameRef.current);}else if(isDocument){addListener(listenerNameRef.current,dbRef.current.onSnapshot(function(doc){if(doc.exists){setData(_objectSpread({},doc.data({serverTimestamps:'estimate'}),{id:doc.id}));}setExists(doc.exists);if(notifyOnNetworkStatusChange)setLoading(false);}));}else{addListener(listenerNameRef.current,dbRef.current.onSnapshot(function(querySnapshot){var array=[];querySnapshot.forEach(function(doc){array.push(_objectSpread({},doc.data({serverTimestamps:'estimate'}),{id:doc.id}));});if(!querySnapshot.empty){setData(array);}setExists(!querySnapshot.empty);if(notifyOnNetworkStatusChange)setLoading(false);}));}case 32:_context.next=38;break;case 34:_context.prev=34;_context.t0=_context["catch"](2);setError(_context.t0);console.error('fuego error: \nuseFuego failed. \nError: ',JSON.stringify(_context.t0));case 38:case"end":return _context.stop();}}},null,this,[[2,34]]);}}]);return _default;}();export{_default as default};
//# sourceMappingURL=index.js.map