import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _regeneratorRuntime from"@babel/runtime/regenerator";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{currentUserExists,roomIsEditModel,roomIsNewModel,roomIsCreateCallable}from'./types';import{fuego,chat}from'../../components/ChatProvider';import{getInitials as _getInitials}from'../../helpers/getInitials';import{firestore}from'firebase';import uuid from'uuid';var _default=function(){function _default(room){_classCallCheck(this,_default);this.room=room;}_createClass(_default,[{key:"getUnreadCount",value:function getUnreadCount(){var _ref=fuego.firebase.auth().currentUser,uid=_ref.uid;try{var member=this.room.members[uid];return member&&member.unreadCount&&member.unreadCount.count||0;}catch(e){console.error("Room getUnreadCount error. Are you sure you initialized the room with the proper members schema?");return 0;}}},{key:"viewMessage",value:function viewMessage(messageId,messageCreatedAt){var _ref$update,ref,_ref2,uid;return _regeneratorRuntime.async(function viewMessage$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;ref=fuego.db.doc(this.path);_ref2=fuego.auth().currentUser,uid=_ref2.uid;return _context.abrupt("return",ref.update((_ref$update={},_defineProperty(_ref$update,"members."+uid+".unreadCount.count",0),_defineProperty(_ref$update,"members."+uid+".unreadCount.lastCleared",fuego.firebase.firestore.FieldValue.serverTimestamp()),_defineProperty(_ref$update,"members."+uid+".unreadCount.lastSeen",{id:messageId,createdAt:messageCreatedAt}),_ref$update)));case 6:_context.prev=6;_context.t0=_context["catch"](0);console.error('Room class: viewMessage() error:',_context.t0);case 9:case"end":return _context.stop();}}},null,this,[[0,6]]);}},{key:"getArrayOfMembersOtherThanMe",value:function getArrayOfMembersOtherThanMe(){var _ref3=this.room,members=_ref3.members;var _ref4=fuego.auth().currentUser,uid=_ref4.uid;return Object.keys(members).filter(function(id){return id!==uid;}).map(function(id){return members[id];});}},{key:"getName",value:function getName(){var _ref5=this.room,members=_ref5.members,name=_ref5.name;if(name)return name;var _ref6=fuego.auth().currentUser,uid=_ref6.uid;var otherPeopleInRoom=Object.keys(members).filter(function(id){return id!==uid;});var namesOfOtherPeopleInRoom=otherPeopleInRoom.map(function(id){return members[id]&&members[id].name&&members[id].name.split(' ')&&members[id].name.split(' ')[0]||'';});if(!namesOfOtherPeopleInRoom.length){console.error('no other members in room',this.room);return'';}if(namesOfOtherPeopleInRoom.length===1)return members[otherPeopleInRoom[0]].name;if(namesOfOtherPeopleInRoom.length===2)return namesOfOtherPeopleInRoom.join(' & ');var commaNames=namesOfOtherPeopleInRoom.slice(0,namesOfOtherPeopleInRoom.length-1).join(', ');var finalName=namesOfOtherPeopleInRoom[namesOfOtherPeopleInRoom.length-1];return commaNames+" & "+finalName;}},{key:"getInitials",value:function getInitials(){var maxNumberOfInitials=arguments.length>0&&arguments[0]!==undefined?arguments[0]:2;var name=this.room.name;if(name)return _getInitials(name);var members=this.getArrayOfMembersOtherThanMe();if(!members.length){console.error('get room initials error: no other members in this room',this.room);return'';}if(members.length===1){return _getInitials(members[0].name,maxNumberOfInitials);}return members.map(function(member){return member.name&&member.name.slice(0,1)||'';}).join('').slice(0,maxNumberOfInitials);}},{key:"leave",value:function leave(){var _ref7,uid;return _regeneratorRuntime.async(function leave$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;if(currentUserExists(fuego.auth().currentUser)){_context2.next=3;break;}throw new Error("ðŸš¨ Fuego auth error: Tried to leave a room, but there is no valid firebase auth object for this user. \n In order to join a room, the user must exist. If you're just testing around and don't want to have valid users, try await firebase.auth().signInAnonymously().");case 3:_ref7=fuego.auth().currentUser,uid=_ref7.uid;return _context2.abrupt("return",fuego.db.doc(this.path).update(_defineProperty({currentMembers:fuego.firebase.firestore.FieldValue.arrayRemove(uid)},"members."+uid,fuego.firebase.firestore.FieldValue.delete())));case 7:_context2.prev=7;_context2.t0=_context2["catch"](0);console.error(_context2.t0);return _context2.abrupt("return",null);case 11:case"end":return _context2.stop();}}},null,this,[[0,7]]);}},{key:"join",value:function join(){try{var _fuego$db$doc$update2;if(!currentUserExists(fuego.auth().currentUser)){throw new Error("ðŸš¨ Fuego auth error: Tried to join a room, but there is no valid firebase auth object for this user. \n In order to join a room, the user must exist. If you're just testing around and don't want to have valid users, try await firebase.auth().signInAnonymously().");}var _ref8=fuego.auth().currentUser,uid=_ref8.uid,displayName=_ref8.displayName;var newMember={name:displayName||'Fredrick Failuretest',exists:true,joinedAt:fuego.firebase.firestore.FieldValue.serverTimestamp()};return fuego.db.doc(this.path).update((_fuego$db$doc$update2={},_defineProperty(_fuego$db$doc$update2,"members."+uid,newMember),_defineProperty(_fuego$db$doc$update2,"currentMembers",fuego.firebase.firestore.FieldValue.arrayUnion(uid)),_fuego$db$doc$update2));}catch(e){console.error(e);return null;}}},{key:"addMembers",value:function addMembers(members){var _firestore$FieldValue;var batch=fuego.db.batch();var ref=fuego.db.doc(this.path);Object.keys(members).forEach(function(uid){return batch.update(ref,_defineProperty({},"members."+uid,members[uid]));});batch.update(ref,{currentMembers:(_firestore$FieldValue=firestore.FieldValue).arrayUnion.apply(_firestore$FieldValue,_toConsumableArray(Object.keys(members)))});return batch.commit();}},{key:"removeMembers",value:function removeMembers(members){var _firestore$FieldValue2;var batch=fuego.db.batch();var ref=fuego.db.doc(this.path);Object.keys(members).forEach(function(uid){return batch.update(ref,_defineProperty({},"members."+uid+".exists",false));});batch.update(ref,{currentMembers:(_firestore$FieldValue2=firestore.FieldValue).arrayRemove.apply(_firestore$FieldValue2,_toConsumableArray(Object.keys(members)))});return batch.commit();}},{key:"create",value:function create(){return _regeneratorRuntime.async(function create$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;if(!roomIsNewModel(this.room)){_context3.next=3;break;}return _context3.abrupt("return",this.addToFirebase());case 3:throw new Error('Tried to create room without the proper schema. See NewRoomModel typescript type.');case 6:_context3.prev=6;_context3.t0=_context3["catch"](0);console.error(_context3.t0);return _context3.abrupt("return",null);case 10:case"end":return _context3.stop();}}},null,this,[[0,6]]);}},{key:"createViaCallable",value:function createViaCallable(){var create;return _regeneratorRuntime.async(function createViaCallable$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;if(!roomIsCreateCallable(this.room)){_context4.next=4;break;}create=fuego.firebase.functions().httpsCallable(chat.httpCallables.createRoom);return _context4.abrupt("return",create({recipients:this.room.recipients,name:this.room.name||'',avatar:this.room.avatar||''}));case 4:throw new Error('Error: improper room model for Room.createCallable(). The error comes from config for new Room(config). Make sure schema for config is correct');case 7:_context4.prev=7;_context4.t0=_context4["catch"](0);console.error(_context4.t0);return _context4.abrupt("return",{data:null});case 11:case"end":return _context4.stop();}}},null,this,[[0,7]]);}},{key:"edit",value:function edit(){try{if(roomIsEditModel(this.room))return this.updateOnFirebase();throw new Error('Tried to edit room without the proper schema. See EditRoomModel typescript type.');}catch(e){console.error(e);return null;}}},{key:"getUsersTyping",value:function getUsersTyping(){return this.getArrayOfMembersOtherThanMe().filter(function(member){return member.typing&&member.typing.state==='typing';});}},{key:"updateOnFirebase",value:function updateOnFirebase(){var _ref9=this.room,id=_ref9.id,room=_objectWithoutProperties(_ref9,["id"]);return fuego.db.doc(this.path).update(room);}},{key:"addToFirebase",value:function addToFirebase(){var _ref10=fuego.auth().currentUser,uid=_ref10.uid,displayName=_ref10.displayName,photoURL=_ref10.photoURL;var date=fuego.firebase.firestore.FieldValue.serverTimestamp();var me={name:displayName||'Inexistent Poopnugget',exists:true,avatar:photoURL||'',joinedAt:date};var members=_objectSpread({},this.room.members,_defineProperty({},uid,me));var room={members:members,currentMembers:_toConsumableArray(Object.keys(members)).sort(),createdAt:date,lastEdited:date,lastMessage:{system:true,text:me.name+" started a chat",createdAt:date,id:uuid.v4(),name:me.name}};var ref=fuego.db.collection(chat.roomsCollection).doc();return ref.set(room);}},{key:"path",get:function get(){return chat.roomsCollection+"/"+this.room.id;}},{key:"messagesPath",get:function get(){return this.path+"/"+chat.messagesCollection;}}]);return _default;}();export{_default as default};
//# sourceMappingURL=index.js.map